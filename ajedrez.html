<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ajedrez con Stockfish</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      text-align: center;
      padding: 20px;
    }
    .descripcion {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    table {
      border-collapse: collapse;
      margin: 0 auto;
    }
    td {
      width: 60px;
      height: 60px;
      text-align: center;
      vertical-align: middle;
      font-size: 40px;
      cursor: pointer;
    }
    .white {
      background-color: #f0d9b5;
    }
    .black {
      background-color: #b58863;
    }
    .controls {
      margin: 15px;
    }
    button {
      padding: 10px 15px;
      margin: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    #status {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <div class="descripcion">
    <p>Existen redes neuronales y motores de ajedrez ya entrenados que están disponibles en línea. Estos motores han sido desarrollados y afinados durante años, y pueden ser reutilizados en nuestros propios proyectos gracias a que muchos son de código abierto y están accesibles desde la web.</p>
    <p>En este caso, utilizamos un motor de ajedrez ya entrenado llamado <strong>Stockfish</strong>, uno de los más potentes del mundo. Optamos por usar un motor ya entrenado porque crear y entrenar una red neuronal que comprenda bien el ajedrez requeriría una enorme cantidad de tiempo, datos y poder computacional.</p>
    <p>El motor que usamos ha sido entrenado utilizando más de 10.000 partidas de ajedrez reales, jugadas por expertos y grandes maestros. Gracias a eso, el modelo ha aprendido a evaluar millones de posiciones distintas y a predecir cuál es la mejor jugada en una situación dada.</p>
  </div>

  <div class="controls">
    <button onclick="startGame('w')">Jugar como Blancas</button>
    <button onclick="startGame('b')">Jugar como Negras</button>
    <button onclick="resetGame()">Reiniciar</button>
  </div>

  <table id="chessboard"></table>
  <div id="status">Tu turno (Blancas)</div>

  <!-- Librerías necesarias -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stockfish/stockfish.wasm.js"></script>

  <script>
    const PIECES = {
      p: '♟', r: '♜', n: '♞', b: '♝', q: '♛', k: '♚',
      P: '♙', R: '♖', N: '♘', B: '♗', Q: '♕', K: '♔'
    };

    const game = new Chess();
    let engine = Stockfish();
    let playerColor = 'w';
    let selectedSquare = null;

    engine.onmessage = function (event) {
      const line = typeof event === "object" ? event.data : event;
      if (line.startsWith("bestmove")) {
        const move = line.split(" ")[1];
        game.move({ from: move.slice(0,2), to: move.slice(2,4), promotion: 'q' });
        renderBoard();
        updateStatus();
      }
    };

    function startGame(color) {
      playerColor = color;
      resetGame();
      if (playerColor === 'b') {
        setTimeout(makeEngineMove, 300);
      }
    }

    function resetGame() {
      game.reset();
      renderBoard();
      updateStatus();
    }

    function updateStatus() {
      const status = document.getElementById("status");
      if (game.in_checkmate()) {
        status.textContent = '¡Jaque mate!';
      } else if (game.in_draw()) {
        status.textContent = '¡Empate!';
      } else {
        status.textContent = (game.turn() === playerColor) ? 'Tu turno (' + (playerColor === 'w' ? 'Blancas' : 'Negras') + ')' : 'Pensando...';
        if (game.turn() !== playerColor) {
          setTimeout(makeEngineMove, 300);
        }
      }
    }

    function makeEngineMove() {
      engine.postMessage("position fen " + game.fen());
      engine.postMessage("go depth 15");
    }

    function renderBoard() {
      const board = document.getElementById("chessboard");
      board.innerHTML = '';
      const position = game.board();
      const rows = playerColor === 'w' ? position : [...position].reverse();

      for (let i = 0; i < 8; i++) {
        const row = document.createElement("tr");
        const cols = playerColor === 'w' ? [...Array(8).keys()] : [...Array(8).keys()].reverse();
        for (let j of cols) {
          const cell = document.createElement("td");
          const square = playerColor === 'w'
            ? String.fromCharCode(97 + j) + (8 - i)
            : String.fromCharCode(97 + j) + (i + 1);

          cell.className = (i + j) % 2 === 0 ? 'white' : 'black';
          const piece = position[i][j];
          cell.textContent = piece ? PIECES[piece.color === 'w' ? piece.type.toUpperCase() : piece.type] : '';
          cell.onclick = () => handleCellClick(square);
          row.appendChild(cell);
        }
        board.appendChild(row);
      }
    }

    function handleCellClick(square) {
      if (game.turn() !== playerColor) return;

      if (!selectedSquare) {
        const moves = game.moves({ square, verbose: true });
        if (moves.length > 0) {
          selectedSquare = square;
        }
      } else {
        const move = game.move({ from: selectedSquare, to: square, promotion: 'q' });
        selectedSquare = null;
        if (move) {
          renderBoard();
          updateStatus();
        }
      }
    }

    resetGame();
  </script>
</body>
</html>
